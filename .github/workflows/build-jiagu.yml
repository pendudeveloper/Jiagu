name: Build Jiagu Tool (Linux + Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      # -------------------------
      # 1. Checkout repository
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # 2. Install CMake (Linux only)
      # -------------------------
      - name: Install CMake (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y cmake

      # -------------------------
      # 3. Setup JDK 17
      # -------------------------
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # -------------------------
      # 4. Setup Gradle
      # -------------------------
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # -------------------------
      # 5. Make Gradle executable (Linux only)
      # -------------------------
      - name: Make gradlew executable
        if: matrix.os == 'ubuntu-latest'
        run: chmod +x ./gradlew

      # -------------------------
      # 6. Build the entire Android project
      # -------------------------
      - name: Build Android modules
        run: ./gradlew clean assembleRelease --no-daemon

      # -------------------------
      # 7. Build pack.jar
      # -------------------------
      - name: Build pack.jar
        run: ./gradlew :pack:jar --no-daemon

      # -------------------------
      # 8. Prepare JiaguTool output
      # -------------------------
      - name: Prepare JiaguTool package
        run: |
          rm -rf JiaguTool
          mkdir -p JiaguTool

          # Copy bin, keystore, input
          cp -r bin JiaguTool/ || xcopy bin JiaguTool\\bin /E /I /Y
          cp -r keystore JiaguTool/ || xcopy keystore JiaguTool\\keystore /E /I /Y
          cp -r input JiaguTool/ || xcopy input JiaguTool\\input /E /I /Y

          # Copy pack.jar
          cp pack/build/libs/*.jar JiaguTool/pack.jar || copy pack\\build\\libs\\*.jar JiaguTool\\pack.jar

      # -------------------------
      # 9. Create ZIP
      # -------------------------
      - name: ZIP JiaguTool
        run: |
          zip -r JiaguTool-${{ matrix.os }}.zip JiaguTool/ || powershell Compress-Archive -Path JiaguTool -DestinationPath JiaguTool-${{ matrix.os }}.zip

      # -------------------------
      # 10. Upload artifacts
      # -------------------------
      - name: Upload JiaguTool artifact
        uses: actions/upload-artifact@v4
        with:
          name: JiaguTool-${{ matrix.os }}
          path: JiaguTool-${{ matrix.os }}.zip
          retention-days: 30
